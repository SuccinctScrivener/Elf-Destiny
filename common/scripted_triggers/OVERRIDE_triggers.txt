#Needs CHARACTER and FAITH
relation_with_character_is_incestuous_in_faith_trigger = {
	AND = {
		NOT = { culture = { has_cultural_parameter = consanguinity_unrestricted_incest } }
		OR = {
			# doctrine_consanguinity_dynastic; not within the same descent group
			AND = {
				$FAITH$ = { has_doctrine = doctrine_consanguinity_dynastic }
				OR = {
					is_close_or_extended_family_of = $CHARACTER$
					dynasty = $CHARACTER$.dynasty
				}
			}
			#doctrine_consanguinity_restricted; absolutely no family business 
			AND = {
				$FAITH$ = { has_doctrine = doctrine_consanguinity_restricted }
				is_close_or_extended_family_of = $CHARACTER$ #[parents, children, siblings, grandparents, grandchildren, cousins, uncles, aunts, nephews, nieces]
			}
			#doctrine_consanguinity_cousins; the only acceptable incest is with your cousin
			AND = {
				$FAITH$ = { has_doctrine = doctrine_consanguinity_cousins }
				OR = {
					is_close_family_of = $CHARACTER$ #[parents, children, siblings, grandparents, grandchildren]
					is_uncle_or_aunt_of = $CHARACTER$
					is_nibling_of = $CHARACTER$
				}
			}
			#doctrine_consanguinity_aunt_nephew_and_uncle_niece; extended family is ok
			AND = {
				$FAITH$ = { has_doctrine = doctrine_consanguinity_aunt_nephew_and_uncle_niece }	
				is_close_family_of = $CHARACTER$
			}
			#doctrine_consanguinity_unrestricted; all forms of incest is acceptable
		}	
	}
}

# SECRET INCEST
secret_incest_is_valid_trigger = {
    $OWNER$ = {
        is_adult = yes
        NOT = {
            has_trait = incestuous
            culture = { has_cultural_parameter = consanguinity_unrestricted_incest }
        }
    }
}

secret_incest_is_shunned_trigger = {
    $OWNER$ = {
        OR = {
            faith = { NOT = { has_doctrine_parameter = allows_unrestricted_marriage } }
            any_liege_or_above = { faith = { NOT = { has_doctrine_parameter = allows_unrestricted_marriage } } }
            culture = { NOT = { has_cultural_parameter = consanguinity_unrestricted_incest } }
        }
    }
}

secret_incest_is_criminal_trigger = {
    $OWNER$ = { always = no }
}
# SECRET INCEST - END

has_tradition_incestuous = {
    culture = { has_cultural_tradition = tradition_familial_familiarity }
}

#two characters could potentially marry (does NOT check that they're unmarried)
could_marry_character_trigger = {
	save_temporary_scope_as = can_marry_check
	can_marry_common_trigger = yes
	$CHARACTER$ = { can_marry_common_trigger = yes }
	#Opposite genders if you don't have accepted same-sex marriage game rule enabled and your faith supports it
	trigger_if = {
		limit = {
			$CHARACTER$ = { allowed_to_marry_same_sex_trigger = no }
		}
		sex_opposite_of = $CHARACTER$
	}
	#Have you recently divorced this character?
	NOT = {
		has_opinion_modifier = {
			modifier = divorced_me_opinion
			target = $CHARACTER$
		}
	}
	#Faith hostility & consanguinity
	trigger_if = {
		limit = { NOT = { is_courtier_of = $CHARACTER$ } } #If you're someone's courtier, your liege can marry you anyway
		faith = {
			faith_allows_marriage_consanguinity_trigger = {
				CHARACTER_1 = scope:can_marry_check
				CHARACTER_2 = $CHARACTER$
			}
			#faith_hostility_level = {
			#	target = $CHARACTER$.faith
			#	value < faith_hostility_prevents_marriage_level
			#}
		}
	}
	trigger_if = {
		limit = { $CHARACTER$ = { NOT = { is_courtier_of = scope:can_marry_check } } } #If you're someone's courtier, your liege can marry you anyway
		$CHARACTER$.faith = {
				faith_allows_marriage_consanguinity_trigger = {
				CHARACTER_1 = scope:can_marry_check
				CHARACTER_2 = $CHARACTER$
			}
			#faith_hostility_level = {
			#	target = scope:can_marry_check.faith
			#	value < faith_hostility_prevents_marriage_level
			#}
		}
	}
	trigger_if = {
		limit = {
			any_close_or_extended_family_member = {
				any_spouse = { this = $CHARACTER$ }
			}
		}
		faith = { has_doctrine = doctrine_consanguinity_unrestricted }
		$CHARACTER$ = {
			faith = { has_doctrine = doctrine_consanguinity_unrestricted }
			NOT = {
				any_spouse = {
					is_close_or_extended_family_of = scope:can_marry_check
					NOT = {
						faith = { has_doctrine = doctrine_consanguinity_unrestricted }
					}
				}
			}
		}
	}
	# Cannot marry self
	NOT = {
		scope:can_marry_check = { is_spouse_of = $CHARACTER$ }
	}
}

# Same trigger as above with the exception of the recent divorce trigger
can_take_as_concubine_character_trigger = {
	save_temporary_scope_as = can_marry_check
	can_marry_common_trigger = yes
	$CHARACTER$ = { can_marry_common_trigger = yes }
	#Opposite genders if you don't have accepted same-sex marriage game rule enabled and your faith supports it
	trigger_if = {
		limit = {
			$CHARACTER$ = { allowed_to_marry_same_sex_trigger = no }
		}
		sex_opposite_of = $CHARACTER$
	}
	#Faith hostility & consanguinity
	trigger_if = {
		limit = { NOT = { is_courtier_of = $CHARACTER$ } } #If you're someone's courtier, your liege can marry you anyway
		faith = {
			faith_allows_marriage_consanguinity_trigger = {
				CHARACTER_1 = scope:can_marry_check
				CHARACTER_2 = $CHARACTER$
			}
			#faith_hostility_level = {
			#	target = $CHARACTER$.faith
			#	value < faith_hostility_prevents_marriage_level
			#}
		}
	}
	trigger_if = {
		limit = { $CHARACTER$ = { NOT = { is_courtier_of = scope:can_marry_check } } } #If you're someone's courtier, your liege can marry you anyway
		$CHARACTER$.faith = {
				faith_allows_marriage_consanguinity_trigger = {
				CHARACTER_1 = scope:can_marry_check
				CHARACTER_2 = $CHARACTER$
			}
			#faith_hostility_level = {
			#	target = scope:can_marry_check.faith
			#	value < faith_hostility_prevents_marriage_level
			#}
		}
	}
	NOT = {
		scope:can_marry_check = { is_spouse_of = $CHARACTER$ }
	}
}

accepts_incest_with_trigger = {
    OR = {
        NOT = { is_close_or_extended_family_of = $CHARACTER$ } #Actually no incest here!
        is_incestuous_trigger = yes
        has_relation_potential_lover = $CHARACTER$
        has_relation_lover = $CHARACTER$
        culture = { has_cultural_parameter = consanguinity_unrestricted_incest }
    }
    save_temporary_scope_as = incest_evaluation
    NOT = { #under 20 trigger is a HARD limit
        guaranteed_under_20_incest_rejection_trigger = {
            TARGET = scope:incest_evaluation
            SEDUCER = $CHARACTER$
        }
    }
}

guaranteed_under_20_incest_rejection_trigger = {
    $TARGET$ = {
        NOT = { is_consort_of = $SEDUCER$ }
        is_close_or_extended_family_of = $SEDUCER$
        age < 20
        age < $SEDUCER$.age
        NOT = { culture = { has_cultural_parameter = consanguinity_unrestricted_incest }}
        is_ai = yes #Players are allowed to choose
    }
}

valid_demand_conversion_conditions_trigger = {
    scope:recipient = {
		NOR = {
			has_strong_hook = scope:actor
			has_trait = devoted
			has_trait = order_member
			is_imprisoned_by = scope:actor
			is_at_war_with = scope:actor
    	}
    }
	scope:actor = {
		trigger_if = {
			limit = {
				government_has_flag = government_is_landless_adventurer
				scope:recipient = { is_courtier_of = scope:actor }
			}
			custom_tooltip = {
				text = valid_demand_conversion_conditions_trigger.tt.domicile_requires_shrine
				domicile = { has_domicile_parameter = camp_enable_conversion }
			}
		}
		NAND = {
			has_trait = nomadic_philosophy
			has_trait = zealous
		}
	}

    # Elf Destiny
    custom_tooltip = {
        text = "CANT_CONVERT_AELURAN_ORDER_MEMBER"
        NAND = {
            scope:actor.faith.religion = {
                NOT = {
                    is_in_family = rf_spark
                }
            }
            scope:recipient = {
                is_aeluran_sister_or_higher = yes
            }
        }
    }

    custom_description = {
        text = "is_head_of_religion"
        subject = scope:recipient
		scope:recipient.faith.religious_head != scope:recipient
    }

    custom_description = {
        text = "is_protected_via_contract"
        subject = scope:recipient
		# Vassal Contract forbids meddling by liege
		NAND = {
            exists = scope:recipient.liege
            scope:recipient.liege = scope:actor
            scope:recipient = {
                is_ruler = yes
                vassal_contract_has_flag = religiously_protected
            }
        }
    }

    trigger_if = {
        limit = {
            scope:recipient = {
                AND = {
                    has_variable = cannot_be_converted_by_value
                    var:cannot_be_converted_by_value = scope:actor
                }
            }
        }
        custom_tooltip = {
            text = promised_to_not_convert_character
            scope:recipient = {
                NOR = {
                    has_variable = cannot_be_converted_by_value
                    var:cannot_be_converted_by_value = scope:actor
                }
            }
        }
    }

    custom_tooltip = {
        text = cannot_take_overt_hostile_actions_against_diarch.tt
        NOT = { scope:recipient ?= scope:actor.diarch }
    }
}


portrait_wear_armor_trigger = {
	exists = this
	is_incapable = no
	is_imprisoned = no
	trigger_if = {
		limit = { exists = involved_activity }
		involved_activity = { has_activity_type = activity_tournament }
	}
	NOT = {
		OR = {
			has_court_position = court_astrologer_court_position
			has_any_charioteer_trait = yes
		}
	}
	
  	# Elf Destiny
  	NOT = { has_trait = magi }
  	# Elf Destiny

	portrait_ep2_wedding_clothes_trigger = no
	trigger_if = {
		limit = { portrait_sickness_trigger = yes }
		is_in_army = yes
	}
	OR = {
		# Mercenaries, Holy Orders, Adventurers
		AND = {
			is_ruler = yes
			OR = {
				government_has_flag = government_is_mercenary
				government_has_flag = government_is_holy_order
				has_realm_law = camp_purpose_mercenaries
				has_realm_law = camp_purpose_brigands
			}
		}
		has_trait = order_member
		# Commanding an army
		is_commanding_army = yes
		# Knight in an army
		exists = knight_army
		AND = {
			OR = {
				is_landed_or_landless_administrative = no
				liege = { is_at_war = yes }
			}
			is_councillor = no
			OR = {
				AND = {
					is_knight = yes
					NAND = {
						is_ruler = no
						government_has_flag = government_is_landless_adventurer
						liege ?= {
							NOR = {
								has_realm_law = camp_purpose_mercenaries
								has_realm_law = camp_purpose_brigands
							}
							is_at_war = no
						}
					}
				}
				has_court_position = bodyguard_court_position
				has_court_position = champion_court_position
				has_court_position = garuda_court_position
				has_court_position = akolouthos_court_position
				has_court_position = master_of_arms_camp_officer
				has_court_position = light_cavalry_captain_camp_officer
				has_court_position = camelry_captain_camp_officer
				has_court_position = elephantry_captain_camp_officer
				has_court_position = heavy_cavalry_captain_camp_officer
				has_court_position = horse_archer_captain_camp_officer
				has_court_position = archer_captain_camp_officer
				has_court_position = heavy_infantry_captain_camp_officer
				has_court_position = light_infantry_captain_camp_officer
				has_court_position = pike_captain_camp_officer
			}
		}
		# Marshal lower than Duke
		AND = {
			has_council_position = councillor_marshal
			OR = {
				is_landed_or_landless_administrative = no
				primary_title.tier < tier_kingdom
			}
		}
		# Military style governor
		trigger_if = {
			limit = {
				is_independent_ruler = no
				OR = {
					has_government = celestial_government
					has_government = meritocratic_government
					has_government = steppe_admin_government
				}
			}
			OR = {
				vassal_contract_has_flag = celestial_province_protectorate
				vassal_contract_has_flag = celestial_province_military
				vassal_contract_has_flag = meritocratic_province_protectorate
				vassal_contract_has_flag = meritocratic_province_military
				has_title = title:e_minister_grand_marshal
			}
			is_adult = yes
			trigger_if = {
				limit = { has_trait = devoted }
				faith = { has_doctrine_parameter = clergy_can_fight }
			}
			save_temporary_scope_as = fighter_temp
			can_be_combatant_based_on_gender_trigger = { ARMY_OWNER = scope:fighter_temp }
		}
		has_character_flag = wear_armor
		# Serving Varangian
		has_character_flag = is_currently_varangian
		# In a Duel
		has_character_flag = single_combat_duel_armor
		has_character_flag = forced_knight_armor
		# In a Tournament
		activity_tournament_armor_trigger = yes
		AND = { # In case these characters become landed they should stop wearing armor
			has_character_flag = military_outfit
			is_ruler = no
		}
		# Died in battle
		trigger_if = {
			limit = { is_alive = no }
			death_reason = death_battle
		}
	}
}

portrait_wear_helmet_trigger = { # Different from Armor, as (crowned) Kings and Emperors should show their crowns!
	exists = this
	trigger_if = {
		limit = { exists = involved_activity }
		involved_activity = {
			NOR = {
				has_activity_type = activity_hunt
				has_activity_type = activity_pilgrimage
				has_activity_type = activity_roaming
			}
		}
	}
	is_incapable = no
	is_imprisoned = no
	NOT = { has_court_position = court_astrologer_court_position }
	trigger_if = {
		limit = { portrait_sickness_trigger = yes }
		is_in_army = yes
	}

  	# Elf Destiny
  	NOT = { has_trait = magi }
  	# Elf Destiny

	OR = {
		# Adventurers
		AND = {
			is_ruler = yes
			government_has_flag = government_is_landless_adventurer
			has_realm_law = camp_purpose_mercenaries
		}
		# Holy Orders
		AND = {
			is_ruler = yes
			government_has_flag = government_is_holy_order
		}
		has_trait = order_member
		# Commanding and lower than a King or uncrowned
		AND = {
			is_commanding_army = yes
			OR = {
				is_landed_or_landless_administrative = no
				AND = {
					exists = primary_title
					OR = {
						primary_title.tier < tier_kingdom
						portrait_wear_no_crown_trigger = yes
					}
				}
			}
		}
		# Knight in an army
		exists = knight_army
		# Non-Council Knight lower than King and liege is at war
		AND = {
			is_knight = yes
			is_councillor = no
			OR = {
				is_landed_or_landless_administrative = no
				AND = {
					exists = primary_title
					primary_title.tier < tier_kingdom
					liege = { is_at_war = yes }
				}
			}
			NAND = {
				is_ruler = no
				government_has_flag = government_is_landless_adventurer
				liege ?= {
					is_at_war = no
					NOT = { has_realm_law = camp_purpose_mercenaries }
				}
			}
		}
		# Marshal lower than Duke
		AND = {
			has_council_position = councillor_marshal
			OR = {
				is_landed_or_landless_administrative = no
				primary_title.tier < tier_duchy
			}
		}
		has_character_flag = wear_armor
		# Serving Varangian
		has_character_flag = is_currently_varangian
		# In a Duel
		has_character_flag = single_combat_duel_armor
		# In a Tournament
		activity_tournament_armor_trigger = yes
		AND = { # In case these characters become landed they should stop wearing armor
			has_character_flag = military_outfit
			is_ruler = no
		}
		# Military style governor
		AND = {
			is_independent_ruler = no
			OR = {
				has_government = celestial_government
				has_government = meritocratic_government
				has_government = steppe_admin_government
			}
			OR = {
				vassal_contract_has_flag = celestial_province_protectorate
				vassal_contract_has_flag = celestial_province_military
				vassal_contract_has_flag = meritocratic_province_protectorate
				vassal_contract_has_flag = meritocratic_province_military
				has_title = title:e_minister_grand_marshal
			}
			is_adult = yes
			trigger_if = {
				limit = { has_trait = devoted }
				faith = { has_doctrine_parameter = clergy_can_fight }
			}
			save_temporary_scope_as = fighter_temp
			can_be_combatant_based_on_gender_trigger = { ARMY_OWNER = scope:fighter_temp }
		}
	}
	NOR = {
		activity_tournament_shirtless_trigger = yes
		has_character_flag = no_hat
	}
	# Not peasants leading revolts
	NAND = {
		has_trait = peasant_leader
		OR = {
			is_ruler = no
			is_leading_faction_type = peasant_faction
			AND = {
				is_ruler = yes
				is_landed_or_landless_administrative = no
				OR = {
					government_has_flag = government_is_feudal
					government_has_flag = government_is_clan
				}
			}
		}
	}
}
portrait_wear_armor_currently_in_army_trigger = {
    exists = this

    # Elf Destiny
    NOT = { has_trait = magi }
    # Elf Destiny

    OR = {
        is_commanding_army = yes
        exists = knight_army
    }
}

mpo_permafrost_building_trigger = {
	trigger_if = {
		limit = {
			county = {
				has_county_modifier = mpo_siberian_permafrost_modifier
			}		
		}
		culture ?= scope:holder.culture
		culture ?= {
            OR = {
                has_cultural_tradition = tradition_mpo_northern_tribes
                has_cultural_tradition = tradition_elven_northern_tribes
            }
		}
	}
}

building_requirement_tribal = {
	scope:holder ?= {
		OR = {
			government_has_flag = government_is_tribal
			government_has_flag = government_is_advanced_tribal
			government_has_flag = government_is_nomadic
			government_has_flag = government_is_wanua
		}
	}
}